<!DOCTYPE html>
<html lang="en">
<head>

<style>
  body, p, li, summary, button, pre, textarea { line-height: 1.7 !important; }
  #menuToggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    width: 40px;
    height: 40px;
    background: #111;
    border: 2px solid #00ffcc;
    border-radius: 5px;
    cursor: pointer;
  }

  #menuToggle div {
    width: 60%;
    height: 4px;
    margin: 6px auto;
    background-color: #00ffcc;
  }

  #infoPanel {
    display: none;
    position: fixed;
    top: 0;
    right: 0;
    height: 100%;
    width: 90%;
    max-width: 400px;
    background: #111;
    color: #00ffcc;
    border-left: 3px solid #00ffcc;
    padding: 1rem;
    overflow-y: auto;
    z-index: 9998;
    font-size: 0.6rem;
  }

  #infoPanel h2 {
    font-size: 0.9rem;
    color: #ff00ff;
    margin-bottom: 0.5rem;
  }

  #infoPanel details {
    border: none;
    padding: 0;
    margin-top: 1rem;
  }

  #infoPanel summary {
    font-weight: bold;
    color: #00ffcc;
    cursor: pointer;
    font-size: 0.75rem;
  }

  .prompt-block {
    margin-top: 1rem;
  }

  .prompt-block pre {
    white-space: pre-wrap;
    background: #111;
    color: #0f0;
    border: 1px solid #00ffcc;
    padding: 0.75rem;
    border-radius: 4px;
  }

  .prompt-block button {
    background-color: #1f1f1f;
    border: 2px solid #00ffcc;
    color: #00ffcc;
    font-family: inherit;
    font-size: 0.6rem;
    padding: 0.5rem;
    margin-top: 0.25rem;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
  }
</style>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SB3 Route Planner</title>
  <style>
  body, p, li, summary, button, pre, textarea { line-height: 1.7 !important; }
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    html { scroll-behavior: smooth; }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: radial-gradient(circle at center, #1a1a1a, #000);
      color: #00ffcc;
      font-family: 'Press Start 2P', monospace;
      padding: 1rem;
      text-shadow: 0 0 2px #00ffcc;
    }

    h1, h2 {
      font-size: 1rem;
      color: #ff00ff;
      margin: 1rem 0;
      text-align: center;
    }

    input[type="file"], button, a {
      width: 100%;
      box-sizing: border-box;
      background-color: #1f1f1f;
      border: 2px solid #00ffcc;
      color: #00ffcc;
      font-family: inherit;
      padding: 0.75rem;
      font-size: 0.7rem;
      margin-top: 1rem;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      display: block;
      text-decoration: none;
    }

    #mapsLink a { display: block;
      margin-top: 0.5rem;
      background: #00ffcc;
      color: #000;
      font-weight: bold;
      text-shadow: none;
    }

    #mapsLink a:hover, button:hover {
      background-color: #00cccc;
      color: black;
    }

    textarea {
      width: 100%;
      font-family: monospace;
      background: #111;
      color: #0f0;
      border: 2px solid #00ffcc;
      padding: 10px;
      border-radius: 5px;
      margin-top: 1rem;
    }

    #status {
      margin-top: 10px;
      color: #00ffcc;
      font-size: 0.75rem;
      text-align: center;
    }

    @media (max-width: 600px) {
      #map { height: 300px; }
      textarea { font-size: 0.6rem; }
    }

    #map {
      height: 500px;
      width: 100%;
      margin-top: 1rem;
      border: 3px dotted #ff00ff;
    }

    ol {
      margin-top: 1rem;
      padding-left: 1rem;
      background-color: rgba(255, 255, 255, 0.05);
      border-left: 4px solid #00ffcc;
    }

    li {
      margin-bottom: 0.5rem;
      font-size: 0.6rem;
    }

    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    html { scroll-behavior: smooth; }
    * { box-sizing: border-box; }

    body {
      background: radial-gradient(circle at center, #2e2e2e, #000000);
      color: #00ffcc;
      font-family: 'Press Start 2P', monospace;
      padding: 1rem;
      max-width: 100%;
      text-shadow: 0 0 4px #00ffcc;
    }

    h1 {
      font-size: 1.25rem;
      color: #ff00ff;
      margin-bottom: 1rem;
      text-align: center;
    }

    input[type="text"],
    input[type="file"], button, #mapsLink {
      background-color: #1f1f1f;
      border: 2px solid #00ffcc;
      color: #00ffcc;
      font-family: 'Press Start 2P', monospace;
      padding: 0.5rem;
      font-size: 0.65rem;
      margin-top: 1rem;
      border-radius: 6px;
      cursor: pointer;
      display: inline-block;
      text-decoration: none;
      width: 100%; 
      box-sizing: border-box; 
    }
     #aiRouteGenerator input[type="text"], #aiRouteGenerator textarea {
        font-family: 'Press Start 2P', monospace;
        background: #111;
        color: #0f0; 
        border: 1px solid #00ffcc; 
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem; 
    }
    #aiRouteGenerator textarea {
        height: auto; 
        min-height: 60px; 
    }


    #mapsLink {
      display: none; 
      background-color: #00ffcc;
      color: #000;
      font-weight: bold;
      text-shadow: none;
    }

    #mapsLink:hover, button:hover {
      background-color: #00cccc;
      color: black;
    }

    #pasteArea {
      display: none;
      margin-top: 1rem;
    }

    textarea { 
      width: 100%;
      font-family: monospace;
      background: #111;
      color: #0f0;
      border: 2px solid #00ffcc;
      padding: 10px;
      border-radius: 5px;
    }

    #status, #aiStatus {
      margin-top: 10px;
      color: #00ffcc;
      font-size: 0.75rem;
      text-align: center;
    }
     #aiStatus {
        font-size: 0.6rem; 
    }


    @media (max-width: 600px) {
      #map { height: 300px; }
    }
    #map {
      height: 500px;
      width: 100%;
      margin-top: 1rem;
      border: 3px dotted #ff00ff;
    }

    ol {
      padding-left: 2rem;
      background-color: rgba(255, 255, 255, 0.05);
      border-left: 5px solid #00ffcc;
      margin-top: 1rem;
      padding: 1rem;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMFmXm-gGi7bO7Bq5YD0SaB0fvk3ZrS_4&libraries=places&callback=initMapAsync" async defer></script>
</head>
<body>

  <h1>SB3 Route Planner</h1>

  <!-- AI Route Generation -->
  <div id="aiRouteGenerator" style="margin-bottom: 2rem; border: 2px solid #ff00ff; padding: 1rem; border-radius: 6px;">
    <h2 style="font-size: 0.8rem; color: #00ffcc;">Generate Route with AI (GPT-4)</h2>
    <input type="text" id="aiTownCity" placeholder="Enter Town/City (e.g., Austin, TX)">
    <input type="text" id="aiStartLocation" placeholder="Enter Start Address (e.g., 123 Main St, Austin, TX)">
    <input type="text" id="aiEndLocation" placeholder="Enter End Address (e.g., 456 Oak Ave, Austin, TX)">
    <textarea id="aiStoreTypes" rows="3" placeholder="Enter types of stores, comma-separated (e.g., coffee shop, bookstore, grocery store)"></textarea>
    <button onclick="generateRouteWithAI()">Generate AI Route</button>
    <div id="aiStatus"></div>
  </div>
  
<!-- File Upload Input -->
<input type="file" id="fileInput" accept=".json">
  
<!-- Paste JSON Toggle -->
<button onclick="togglePaste()">Paste & Load JSON</button>
  
<!-- JSON Paste Area -->
<div id="pasteArea">
    <textarea id="jsonInput" rows="10" placeholder="Paste your JSON route here..."></textarea>
    <button onclick="processPastedJson()">Load Route</button>
    <div id="status"></div>
  </div>
  
    <button onclick="toggleLocationList()">Toggle Location List</button>
    
<!-- Route List Output Section -->
<div id="routeOutput" style="display:none;"></div>
    
  <a id="mapsLink" href="#" target="_blank">Open Optimized Route in Google Maps</a>
  
<!-- Google Maps Display -->
<div id="map"></div>

<!-- Hamburger Menu Icon -->
<div id="menuToggle" onclick="toggleMenu()">
  <div></div>
  <div></div>
  <div></div>
</div>

<!-- Sidebar Panel: Settings, Instructions, Prompts -->
<div id="infoPanel">
  <details style="margin-top:1rem;">
    <summary>How to Use This Tool</summary>
    <div style="margin-top:0.5rem;">
      <p>This tool helps you plan routes using a list of locations formatted in JSON. You can upload your route or paste it manually, or use the AI Route Generator. The map will generate driving segments optimized for Google Maps mobile limits.</p>
      <ol style="padding-left: 1.2rem; margin-top: 1rem;">
        <li><strong>Use AI Generator:</strong> Fill in the town, start/end addresses, and store types, then click "Generate AI Route".</li>
        <li><strong>Or, paste or upload your JSON:</strong> It should start and end with your home or base address, with stops in between.</li>
        <li>The Google Maps API key is embedded. The OpenAI API key for AI generation is also embedded.</li>
        <li><strong>Review your route:</strong> Use checkboxes to remove any stops you don't want to include. The tool updates the route and buttons automatically.</li>
        <li><strong>Navigate:</strong> Use the generated route buttons to open each segment in Google Maps (mobile-friendly limit of 10 stops per route).</li>
      </ol>
    </div>
  </details>

  <details><summary>AI Prompt Examples</summary><div style="margin-top:0.5rem;">
    <div class="prompt-block">
      <strong>Multiple Store Types</strong>
      <pre id="prompt_0">Find all Target, Best Buy, and Dollar General locations in a city. Format the results as a JSON array like this:

[
  { "name": "Start", "address": "[START_ADDRESS]" },
  { "name": "Stop 1", "address": "123 Example Blvd, City, ST ZIP" },
  ...
  { "name": "End", "address": "[END_ADDRESS]" }
]</pre>
      <button onclick="copyPrompt(0)">Copy</button>
    </div>
    <div class="prompt-block">
      <strong>Inventory Check Route</strong>
      <pre id="prompt_1">I need to visit every GameStop in town to check inventory. Start and end at [HOME_ADDRESS]. Return a list of store names and addresses formatted like:

[
  { "name": "Start", "address": "[HOME_ADDRESS]" },
  { "name": "GameStop 1", "address": "..." },
  ...
  { "name": "End", "address": "[HOME_ADDRESS]" }
]</pre>
      <button onclick="copyPrompt(1)">Copy</button>
    </div>
    </div>
  </details>
</div>

<script>
    let directionsService, directionsRenderer, currentLocations;

    function initMapAsync() {
      initMap();
    }

    function initMap() {
      if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        console.error("Google Maps API not loaded yet. initMap called prematurely.");
        return;
      }
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer();
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: { lat: 33.5779, lng: -101.8552 } 
      });
      directionsRenderer.setMap(map);
    }

    function togglePaste() {
      const pasteBox = document.getElementById("pasteArea");
      pasteBox.style.display = pasteBox.style.display === 'none' ? 'block' : 'none';
    }

    function processPastedJson(jsonString) {
      let rawJson;
      if (typeof jsonString === 'string') {
        rawJson = jsonString;
      } else {
        rawJson = document.getElementById("jsonInput").value;
      }
      try {
        const locations = JSON.parse(rawJson);
        currentLocations = locations; 
        displayRoute(locations);
        planRoute(locations);
        document.getElementById("status").innerText = "Route loaded successfully!";
      } catch (err) {
        document.getElementById("status").innerText = "Invalid JSON format.";
        console.error("Error processing JSON:", err, "Raw JSON:", rawJson);
      }
    }

    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById("jsonInput").value = e.target.result; 
        processPastedJson(e.target.result); 
      };
      reader.readAsText(file);
    });

    function displayRoute(locations) {
      const output = document.getElementById('routeOutput');
      output.style.display = 'block';
      output.innerHTML = '<h2>Route Stops:</h2>'; 
      const list = document.createElement('ol');
      locations.forEach((location, index) => { 
        const item = document.createElement("li");
        item.style.display = "flex";
        item.style.alignItems = "flex-start"; 
        item.style.gap = "0.5rem";
        item.style.marginBottom = "0.5rem"; 

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        checkbox.id = `loc_checkbox_${index}`; 
        checkbox.style.marginTop = "0.2em"; 

        const label = document.createElement("span");
        label.textContent = `${location.name}: ${location.address}`;
        label.style.lineHeight = "1.5"; 

        checkbox.addEventListener("change", updateFromCheckboxes);
        
        item.appendChild(checkbox);
        item.appendChild(label);
    
        list.appendChild(item);
      });
      output.appendChild(list);
    }
    
    function planRoute(locations) {
      if (!google || !google.maps || !directionsService || !directionsRenderer) {
        console.warn("Google Maps API components not ready for planRoute.");
        document.getElementById("status").innerText = "Map service not ready. Please wait a moment and try again.";
        return;
      }
      if (!locations || locations.length < 2) {
        document.getElementById("status").innerText = "Need at least two locations to plan a route.";
        if(directionsRenderer) directionsRenderer.setDirections({routes: []}); 
        document.getElementById("mapsLink").style.display = "none";
        return;
      }

      const origin = locations[0].address.trim();
      const destination = locations[locations.length - 1].address.trim();
      const waypoints = locations.slice(1, -1).map(loc => ({
        location: loc.address.trim(),
        stopover: true
      }));

      directionsService.route({
        origin,
        destination,
        waypoints,
        travelMode: google.maps.TravelMode.DRIVING,
        optimizeWaypoints: true 
      }, (response, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(response);
          
          const optimizedRoutePoints = [];
          optimizedRoutePoints.push({ name: locations[0].name, address: response.routes[0].legs[0].start_address }); 

          response.routes[0].legs.forEach((leg, legIndex) => {
            if (legIndex < response.routes[0].legs.length -1) {
                 const waypointOrderIndex = response.routes[0].waypoint_order[legIndex];
                 optimizedRoutePoints.push({
                    name: locations[waypointOrderIndex + 1].name, 
                    address: leg.end_address
                 });
            }
          });
          optimizedRoutePoints.push({ name: locations[locations.length-1].name, address: response.routes[0].legs[response.routes[0].legs.length - 1].end_address}); 


          const chunks = [];
          for (let i = 0; i < optimizedRoutePoints.length -1; i += (8 + 1) ) { 
            const chunkEndIndex = Math.min(i + (8+1) , optimizedRoutePoints.length - 1);
            const chunkOrigin = optimizedRoutePoints[i].address;
            const chunkDest = optimizedRoutePoints[chunkEndIndex].address;
            const chunkWaypoints = optimizedRoutePoints.slice(i + 1, chunkEndIndex).map(loc => loc.address);
            
            chunks.push({ origin: chunkOrigin, destination: chunkDest, waypoints: chunkWaypoints });
          }

          const container = document.getElementById("mapsLink");
          container.innerHTML = ""; 
          if (chunks.length > 0) {
            chunks.forEach((chunk, idx) => {
              const chunkUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(chunk.origin)}&destination=${encodeURIComponent(chunk.destination)}&travelmode=driving&waypoints=${chunk.waypoints.map(encodeURIComponent).join('|')}`;
              const btn = document.createElement("a");
              btn.href = chunkUrl;
              btn.target = "_blank";
              btn.textContent = `Open Route Part ${idx + 1}`;
              container.appendChild(btn);
            });
            container.style.display = 'block';
          } else {
             container.style.display = 'none';
          }
          document.getElementById("status").innerText = "Route planned successfully.";
        } else {
          document.getElementById("status").innerText = 'Directions request failed due to ' + status;
          console.error('Directions request failed due to ' + status, response);
        }
      });
    }

    function updateFromCheckboxes() {
      const selectedLocations = [];
      const displayedItems = document.querySelectorAll('#routeOutput ol li');
      
      displayedItems.forEach((li, index) => {
        const checkbox = li.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked && currentLocations[index]) {
          selectedLocations.push(currentLocations[index]);
        }
      });

      if (selectedLocations.length >= 2) {
        planRoute(selectedLocations);
      } else {
        document.getElementById("mapsLink").style.display = "none";
        if (directionsRenderer) directionsRenderer.setDirections({routes: []}); 
        document.getElementById("status").innerText = "Select at least two locations for a route.";
      }
    }
  
    function toggleLocationList() {
      const routeBlock = document.getElementById("routeOutput");
      routeBlock.style.display = routeBlock.style.display === 'none' ? 'block' : 'none';
    }

    async function generateRouteWithAI() {
      const townCity = document.getElementById("aiTownCity").value.trim();
      const startLocation = document.getElementById("aiStartLocation").value.trim();
      const endLocation = document.getElementById("aiEndLocation").value.trim();
      const storeTypesRaw = document.getElementById("aiStoreTypes").value.trim();
      const aiStatus = document.getElementById("aiStatus");

      if (!townCity || !startLocation || !endLocation || !storeTypesRaw) {
        aiStatus.innerText = "Please fill in all AI generation fields.";
        return;
      }
      aiStatus.innerText = "Generating route with AI... Please wait.";

      const storeTypesArray = storeTypesRaw.split(',').map(s => s.trim()).filter(s => s);
      let stopsPrompt = "";
      storeTypesArray.forEach((type, index) => {
        stopsPrompt += `  { "name": "${type}", "address": "..." }`; 
        if (index < storeTypesArray.length - 1) {
          stopsPrompt += ",\n";
        }
      });

      const prompt = `
Please generate a JSON array for a route.
The route is in ${townCity}.
The route starts at "${startLocation}".
The route ends at "${endLocation}".
The route should include stops for the following types of places: ${storeTypesArray.join(', ')}.

Format the JSON exactly like this, providing realistic addresses for the stops:
[
  { "name": "Start", "address": "${startLocation}" },
${stopsPrompt}
  { "name": "End", "address": "${endLocation}" }
]

Ensure the output is only the JSON array, with no other text before or after it. Each address should be a complete and plausible address within ${townCity}.
For each store type requested, find one instance. For example, if "coffee shop, bookstore" is requested, find one coffee shop and one bookstore.
The "name" for each stop should reflect the store type requested (e.g., "Coffee Shop", "Bookstore").
`;

      const apiKey = "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";

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify({
            model: 'gpt-4', 
            messages: [
              { role: "system", content: "You are a helpful assistant that generates JSON route data based on user specifications. Only output the JSON array as a valid JSON string, without any surrounding text or markdown." },
              { role: "user", content: prompt }
            ],
            temperature: 0.5
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('OpenAI API Error:', errorData);
          throw new Error('OpenAI API error: ' + response.status + ' ' + response.statusText + ' - ' + (errorData.error ? errorData.error.message : 'Unknown error'));
        }

        const data = await response.json();
        let generatedJsonString = data.choices[0].message.content.trim();
        
        if (generatedJsonString.startsWith('```json')) {
          generatedJsonString = generatedJsonString.substring(7);
          if (generatedJsonString.endsWith('```')) {
            generatedJsonString = generatedJsonString.substring(0, generatedJsonString.length - 3);
          }
        } else if (generatedJsonString.startsWith('```')) {
            generatedJsonString = generatedJsonString.substring(3);
            if (generatedJsonString.endsWith('```')) {
                generatedJsonString = generatedJsonString.substring(0, generatedJsonString.length - 3);
            }
        }
        
        console.log("AI Generated JSON String (cleaned):", generatedJsonString);
        document.getElementById("jsonInput").value = generatedJsonString; 
        processPastedJson(generatedJsonString); 
        aiStatus.innerText = "AI route generated and loaded!";

      } catch (error) {
        console.error("Error generating route with AI:", error);
        document.getElementById("status").innerText = "Error generating route with AI. Check console.";
        aiStatus.innerText = 'Error: ' + error.message;
      }
    }

    function toggleMenu() {
      const panel = document.getElementById("infoPanel");
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function copyPrompt(index) {
      const el = document.getElementById("prompt_" + index);
      navigator.clipboard.writeText(el.innerText)
        .then(() => alert("Prompt copied to clipboard!"))
        .catch(() => alert("Failed to copy prompt."));
    }
</script>

</body>
</html>
